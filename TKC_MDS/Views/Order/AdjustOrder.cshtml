@{
	ViewData["Title"] = "AdjustOrder";
}
<style>
	.table-res{
		box-shadow: 0 0 5px black;
		display:grid;
		grid-template-rows:2.5rem auto;
		width:100%;
		height:70vh;
		box-sizing:border-box;
		& > *{
			box-sizing: border-box;
			min-width:auto;
		}
	}

	.cell-table{
		display:grid !important;
		box-sizing: border-box;
		border:1px solid black;
		box-sizing: border-box;
		width:100%;
		gap:3px;
		grid-template-columns: 1rem clamp(5rem,16%,13rem) clamp(5rem,16%,13rem) clamp(5rem,16%,13rem) clamp(5rem,16%,13rem) clamp(5rem,16%,13rem) clamp(5rem,16%,13rem);
		& > input{
			
			min-width: 0;
			font-size:clamp(0.5rem,2vw,1.3rem);
			display: flex;
			flex-direction: column;
			justify-content: center;
			text-align: center;
			box-sizing: border-box;
			border:none;
			border-left: 1px solid black;
			&:focus {

				outline:none;
				box-shadow:0 0 5px gray;
			}
		}
		& > div{
			border-left: 1px solid black;
			display:flex;
			flex-direction:column;
			justify-content:center;
			text-align:center;
		}
	}
</style>

<div id="kt_app_content" class="app-content flex-column-fluid">
	<!--begin::Content container-->
	<form id="kt_app_content_container" class="app-container container-xxl" onsubmit="return false">
		<!--begin::Row-->
		<div class="row gy-5 g-xl-10">
			<div class="col-xl-2  "></div>

			<!--begin::Col-->
			<div class="col-xl-8  ">
				<!--begin::Table Widget 5-->
				<div class="card card-flush h-xl-100">
					<!--begin::Card header-->
					<div class="card-header pt-7">
						<!--begin::Title-->
						<h3 class="card-title align-items-start flex-column">
							<span class="card-label fw-bold text-dark">ปรับ Order</span>
						</h3>
						<!--end::Title-->
						<!--begin::Actions-->
						<!--end::Actions-->
					</div>
					<!--end::Card header-->
					<!--begin::Card body-->
					<div class="card-body table-responsive">
						<span class="card-label fw-bold text-danger">
							รูปแบบวันที่ วว/ดด/ปปปป
							(คศ)
						</span>
						<!--begin::Table-->
						<table class="table align-middle fs-6 gy-3  " id="kt_table_widget_5_table">
							<!--begin::Table head-->
							<!--begin::Table row-->
							<tbody>
								<tr class="text-start  fw-bold fs-7 text-uppercase gs-0">
									<th class="text-end  text-gray-400 pe-3 min-w-100px">
										ลูกค้า :
									</th>
									<td class="text-end pe-3 min-w-50px">
										<select class="form-select form-select-sm form-select-solid w-200px" id="select_custumer" name="CustID">
											@*<option value="0" selected="selected" disabled="" data-select2-id="select2-data-3-k22b">
												เลือกลูกค้า
											</option>
											<option value="1">4302-MITSUBISHI P/C</option>
											<option value="2">4303-TOYOTA </option>*@

										</select>
									</td>
									<th class="text-end  text-gray-400 pe-3 min-w-100px">
										ประเภทข้อมูล :
									</th>
									<td class="text-end pe-3 min-w-50px">
										<select class="form-select form-select-sm form-select-solid w-200px" id="select_dataType" onchange="selectOrder(this.value)" name="DataType">
											@*<option value="0" selected="selected" disabled="" data-select2-id="select2-data-6-0afp"></option>
											<option value="1">4302-MITSUBISHI P/C</option>
											<option value="2">4303-TOYOTA </option>*@
										</select>
									</td>
								</tr>
								<tr class="text-start  fw-bold fs-7 text-uppercase gs-0">
									<th class="text-end  text-gray-400 pe-3 min-w-100px">
										เลื่อน/ยกเลิก :
									</th>
									<td class="text-end pe-3 min-w-50px">
										<select class="form-select form-select-sm form-select-solid w-200px" id="select_slide_or_cancel" onchange="selectSlideChange(this.value, 'select_order',()=> { selectFillterOrderNo(); selectFillterPO(); })">
											<option value="slide" data-select2-id="select2-data-9-8z3w">01- เลื่อน</option>
											<option value="cancel">02- ยกเลิก </option>
										</select>
									</td>
								</tr>
								<tr class="text-start  fw-bold fs-7 text-uppercase gs-0">
									<th class="text-end  text-gray-400 pe-3 min-w-100px">
										Plant :
									</th>
									<td class="text-end pe-3 min-w-50px">
										<select class="form-select form-select-sm form-select-solid w-200px" id="select_plant" onchange="selectFillter(this.value,'select_order',()=> selectFillterOrderNo())" name="PlantCode">
											<option value="" data-select2-id="select2-data-18-wbd7">All</option>
										</select>
									</td>
								</tr>
								<tr class="text-start  fw-bold fs-7 text-uppercase gs-0">
									<th class="text-end  text-gray-400 pe-3 min-w-100px">
										เลขที่ Orders :
									</th>
									<td class="text-end pe-3 min-w-50px">
										<select class="form-select form-select-sm form-select-solid w-200px " id="select_order" disabled onchange="selectFillter(this.value,'select_po',()=> selectFillterPO())" name="OrdersNo">
											<option value="" data-select2-id="select2-data-18-wbd7">All</option>
										</select>
									</td>
								</tr>
								<tr>
									<th class="text-end  text-gray-400 pe-3 min-w-100px">
										PO :
									</th>
									<td class="text-end pe-3 min-w-50px">
										<select class="form-select form-select-sm form-select-solid w-200px" id="select_po" disabled onchange="selectFillter(this.value,'select_part',()=> { })" name="PONo">
											<option value="" data-select2-id="select2-data-18-wbd7">All</option>
										</select>
									</td>
								</tr>
								<tr class="text-start  fw-bold fs-7 text-uppercase gs-0">
									<th class="text-end  text-gray-400 pe-3 min-w-100px">
										เลื่อนเข้า/ออก :
									</th>
									<td class="text-end pe-3 min-w-50px">
										<select class="form-select form-select-sm form-select-solid w-200px" id="select_slide">
											<option value="in" data-select2-id="select2-data-21-9fmk">เลื่อนเข้า</option>
											<option value="out">เลื่อนออก</option>
										</select>
									</td>
								</tr>
							
								<tr class="text-start  fw-bold fs-7 text-uppercase gs-0">
									<th class="text-end  text-gray-400 pe-3 min-w-100px">
										ระบุพาร์ท :
									</th>
									<td class="text-end pe-3 min-w-50px">
										<select class="form-select form-select-sm form-select-solid w-200px" disabled id="select_part">
											<option value="" data-select2-id="select2-data-24-npyo">0-ทั้งหมด</option>
										</select>
									</td>
									<th>
										<button type="button" class="btn btn-secondary fw-bold fs-7">
											กำหนดพาร์ท
										</button>
									</th>
								</tr>
								@*
								<tr class="text-start  fw-bold fs-7 text-uppercase gs-0">
									<th class="text-end  text-gray-400 pe-3 min-w-100px">
										ระบุโมเดล :
									</th>
									<td class="text-end pe-3 min-w-50px">
										<select class="form-select form-select-sm form-select-solid w-200px">
											<option value="1" data-select2-id="select2-data-27-aww2">0-ทั้งหมด</option>
										</select>
									</td>
									<th>
										<button type="button" class="btn btn-secondary fw-bold fs-7 ">
											กำหนดโมเดล
										</button>
									</th>
								</tr>*@

								<!--end::Table row-->
								<!--end::Table head-->

							</tbody>
						</table>
						<!--end::Table-->
						<div class="d-flex justify-content-center">
							<button class="btn btn-sm fw-bold btn-primary me-2" onclick="clickSave()">บันทึก</button>
							<button class="btn btn-sm fw-bold btn-danger" onclick="cancel()">ยกเลิก</button>
						</div>

					</div>
					<div class="card-body table-responsive">
						<div class="table-res">
							<div>
								<div class="cell-table" style="height:100%;">
									<div>
										#
									</div>
									<div >
										วันที่ต้นทาง
									</div>
									<div >
										Period
									</div>
									<div >
										Time
									</div>
									<div >
										วันที่ปลายทาง
									</div>
									<div>
										Period
									</div>
									<div >
										Time
									</div>
								</div>
							</div>
							<div>
								<div class="cell-table" style="overflow-y:auto;" id="table_cell">
									<sapn >
										#
									</sapn>
									<input type="text" placeholder="mm/dd/yyyy" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}"/>
									<input type="text" placeholder="period" />
									<input type="text" placeholder="hh:mm:ss" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" />
									<input type="text" placeholder="mm/dd/yyyy" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" />
									<input type="text" placeholder="period" />
									<input type="text" placeholder="hh:mm:ss" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" />
								</div>
								<div class="cell-table" style="overflow-y:auto;margin-top:auto.4rem;background-color:gray;">
									<sapn>
										#
									</sapn>
									<input type="text" placeholder="mm/dd/yyyy" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" onchange="addTableCell(this.value)" />
									<input type="text" placeholder="period" readonly/>
									<input type="text" placeholder="hh:mm:ss" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" readonly />
									<input type="text" placeholder="mm/dd/yyyy" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" readonly />
									<input type="text" placeholder="period" readonly />
									<input type="text" placeholder="hh:mm:ss" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" readonly />
								</div>
							</div>
						</div>
						@*
						<!--begin::Table-->
						<table class="table align-middle fs-6 gy-3 table-striped table-bordered " id="kt_table_widget_5_table">
							<!--begin::Table head-->
							<thead>
								<!--begin::Table row-->
								<tr class="text-start  fw-bold fs-7 text-uppercase gs-0 ">
									<th class="text-start  text-gray-400 pe-3 min-w-10px">
										#
									</th>
									<th class="text-start  text-gray-400 pe-3 min-w-100px">
										วันที่ต้นทาง
									</th>
									<th class="text-center  text-gray-400 pe-3 min-w-100px">
										Period
									</th>
									<th class="text-start  text-gray-400 pe-3 min-w-100px">
										Time
									</th>
									<th class="text-center  text-gray-400 pe-3 min-w-100px">
										วันที่ปลายทาง
									</th>
									<th class="text-start  text-gray-400 pe-3 min-w-100px">
										Period
									</th>
									<th class="text-center  text-gray-400 pe-3 min-w-100px">
										Time
									</th>

								</tr>

								<!--end::Table row-->
							</thead>
							<!--end::Table head-->
							<tbody id="body_table">
								<tr >
									<td class="text-start  pe-3 min-w-10px "><input type="text">1</td>
									<td class="text-start  pe-3 min-w-10px "><input type="text" placeholder="mm/dd/yyyy"></td>
									<td class="text-start  pe-3 min-w-10px "><input type="text" placeholder="period"></td>
									<td class="text-start  pe-3 min-w-10px "><input type="text" placeholder="HH:MM:SS"></td>
									<td class="text-start  pe-3 min-w-10px "><input type="text" placeholder="mm/dd/yyyy"></td>
									<td class="text-start  pe-3 min-w-10px "><input type="text" placeholder="period"></td>
									<td class="text-start  pe-3 min-w-10px "><input type="text" placeholder="HH:MM:SS"></td>

								</tr>
								<tr>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
								</tr>
								<tr>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
								</tr>
								<tr>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
								</tr>
								<tr>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
								</tr>
								<tr>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
									<td class="text-start  pe-3 min-w-10px"></td>
								</tr>
							</tbody>
						</table>
						<!--end::Table-->
						*@


					</div>
					<!--end::Card body-->
				</div>
				<!--end::Table Widget 5-->
			</div>
			<!--end::Col-->
		</div>
		<!--end::Row-->
	</form>
	<!--end::Content container-->
</div>
<script>
	var ALL_ORDER = [];
	var TABLE_COUNTER = 0;

	const selectOrder = (dataTypeId)=>{
		let select_custumer = document.getElementById("select_custumer");
		//fetch dataType 
		fetch("/order/JsonAdjOrder?custId=" + select_custumer.value + "&dataTypeId=" + dataTypeId)
		.then(res => res.json())
		.then(data => {
			ALL_ORDER = data;
			console.log(data);

			//plant
			const plant = ALL_ORDER.map(order => order.plantCode);
			const plant_set = new Set(plant);
			const option_plant = Array.from(plant_set).reduce((prev, curr) => prev += `<option >${curr}</option>`, `<option value="">All</option>`);
			document.getElementById("select_plant").innerHTML = option_plant;
		})
		.catch(error => console.log(error))
	}

	const selectFillter = (value,nextName,nextFunc)=>{
		if(value != ""){
			document.getElementById(nextName).disabled = false;
			nextFunc();
		}else{
			document.getElementById(nextName).disabled = true;
		}
	}

	const selectSlideChange = (value, nextName,nextFunc) => {
		if (value === "cancel") {
			document.getElementById(nextName).disabled = false; 
			document.getElementById("select_plant").disabled = true;
			document.getElementById("select_po").disabled = false;
			nextFunc();
		} 
	}

	const selectFillterOrderNo = () => {
		//order no
		const orderNo = ALL_ORDER.map(order => order.ordersNo);
		const orderNo_set = new Set(orderNo);
		const option_order = Array.from(orderNo_set).reduce((prev, curr) => prev += `<option >${curr}</option>`, `<option value="">All</option>`);
		document.getElementById("select_order").innerHTML = option_order;
	}

	const selectFillterPO = () => {
		//po
		const poNo = ALL_ORDER.map(order => order.poNo);
		const poNo_set = new Set(poNo);
		const option_poNo = Array.from(poNo_set).reduce((prev, curr) => prev += `<option >${curr}</option>`, `<option value="">All</option>`);
		document.getElementById("select_po").innerHTML = option_poNo;
	}

	const addTableCell = (value)=>{
		//filter
		const plant = document.getElementById("select_plant").value;
		const order = document.getElementById("select_order").value;
		const po = document.getElementById("select_po").value;
		const partNo = document.getElementById("select_part").value;
		const slide = document.getElementById("select_slide").value;

		let filter_order =  ALL_ORDER; //init

		if (plant !== ""){
			filter_order = filter_order.filter(order => order.plantCode === plant);
		}
		if (order !== "") {
			filter_order = filter_order.filter(order => order.ordersNo === order);
		}
		if (po !== "") {
			filter_order = filter_order.filter(order => order.poNo === po);
		}
		if (partNo !== "") {
			filter_order = filter_order.filter(order => order.partNo === partNo);
		}
		const slected_order = filter_order.find(orders => orders.dueDate.startsWith(value));
		console.log("add", slected_order);
		console.log("filter", filter_order);
		if (slected_order){
			console.log(value, slide);
			fetch("/order/ShiftDateTime?date=" + value + "&todo=" + slide)
			.then(res => res.json())
			.then(data => {
				let table_cell = document.getElementById("table_cell");
				const html = `
													<sapn >${TABLE_COUNTER+1}</sapn>
														<input type="text" placeholder="mm/dd/yyyy" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" value="${slected_order?.dueDate}" name="[${TABLE_COUNTER}][Shift][FromDate]"/>
														<input type="text" placeholder="period" value="${slected_order?.period}" name="[${TABLE_COUNTER}][Shift][FromPeriod]"/>
														<input type="text" placeholder="hh:mm:ss" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" value="${slected_order?.dueTime}" name="[${TABLE_COUNTER}][Shift][FromTime]"/>
															<input type="text" placeholder="mm/dd/yyyy" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" value="${data?.date}" name="[${TABLE_COUNTER}][Shift][FromDate]"/>
														<input type="text" placeholder="period" value="${slected_order.dueDate}" name="[${TABLE_COUNTER}][Shift][FromPeriod]"/>
														<input type="text" placeholder="hh:mm:ss" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" value="${slected_order?.dueTime}" name="[${TABLE_COUNTER}][Shift][FromTime]"/>`;

				table_cell.innerHTML = html + table_cell.innerHTML;
				TABLE_COUNTER++;
			}).catch(error=>console.log(error));
		}

	}

	const clickSave=()=>{
		const slide = document.getElementById("select_slide_or_cancel").value;
		const slide_in_out = document.getElementById("select_slide_or_cancel").value;
		if (slide === "cancel"){ //cancel
			const custId = document.getElementById("select_custumer").value;
			const dataType = document.getElementById("select_dataType").value;
			const orderNo = document.getElementById("select_order").value;
			const po = document.getElementById("select_po").value;
			const partNo = document.getElementById("select_part").value;

			Swal.fire({
				title: "คุณแน่ใจแล้วหรือ?",
				text: "ต้องการลบ order!",
				icon: "warning",
				showCancelButton: true,
				confirmButtonColor: "#3085d6",
				cancelButtonColor: "#d33",
				confirmButtonText: "Yes!"
			}).then((result) => {
				if (result.isConfirmed) {
					fetch(`/order/CancelOrder?custId=${custId}&dataType=${dataType}&orderNo=${orderNo}&po=${po}&partNo=${partNo}`,{method:"post"})
						.then(res => res.json())
						.then(data => {
							if (data.msg) {
								Swal.fire(data.msg);
							} else {
								Swal.fire('เกิดข้อผิดพลาด >' + data.error);
							}
						})
						.catch(error => Swal.fire('เกิดข้อผิดพลาด >' + error));
				}
			});


			return;
		}
		if (slide === "slide" && slide_in_out === "in") { //slide in
			fetch("/order/Slide")
			.then(res=> res.json())
			.then(data=>{

			})
			.catch(error => console.log(error));
			return;
		}
		if (slide === "slide" && slide_in_out === "out") { //slide out
			fetch("/order/Slide")
				.then(res => res.json())
				.then(data => {

				})
				.catch(error => console.log(error));
			return;
		}
		Swal.fire('กรุณาเลือก รายการให้ถูกต้อง');
	}

	const cancel = () => { window.location.reload(); }

	window.onload = async () => {
		let select_custumer = document.getElementById("select_custumer");
		const listUser = await fetch("/order/JsonCustumer");
		const users_json = await listUser.json();
		select_custumer.innerHTML = users_json.reduce((prev, curr) => prev += `<option value="${curr?.custID}">${curr?.custID}-${curr?.custName} </option>`, `<option selected > </option>`);

		const dataType = await fetch("/order/JsonDataType_MS");
		const data_type = await dataType.json();
		let select_dataType = document.getElementById("select_dataType");
		select_dataType.innerHTML = data_type.reduce((prev, curr) => prev += `<option value="${curr?.typeCode}">${curr?.typeCode}-${curr?.typeName}</option>`, "<option selected></option>");
		/*
		const order = await fetch("/order/JsonOrders");
		const order_no = await order.json();
		//console.log(order_no);
		let select_order_no = document.getElementById("select_order");
		select_order_no.innerHTML = order_no.reduce((prev, curr) => prev += `<option value="${curr?.ordersNo}">${curr?.custID}-${curr?.ordersNo}</option>`, "<option selected></option>");
		*/
	}
</script>